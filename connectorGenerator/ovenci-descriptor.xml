<control-adapter
    xmlns="http://www.sorbonne-universite.fr/alasca/control-adapter"
    uid="1A10026"
    offered="equipments.oven.OvenExternalControlJava4CI">

  <consumption nominal="2500" min="0" max="2500"/>

  <instance-var modifiers="protected static" type="int" name="MAX_MODE" static-init="3"/>
  <instance-var modifiers="protected static" type="double" name="DEFROST_TEMPERATURE" static-init="80.0"/>
  <instance-var modifiers="protected static" type="double" name="DEFROST_POWER_LEVEL" static-init="500.0"/>
  <instance-var modifiers="protected static" type="double" name="MIN_ADMISSIBLE_TEMP" static-init="20.0"/>
  <instance-var modifiers="protected static" type="double" name="MAX_ADMISSIBLE_DELTA" static-init="50.0"/>
  <instance-var modifiers="protected" type="int" name="currentMode" static-init="2"/>
  <instance-var modifiers="protected" type="boolean" name="isSuspended" static-init="false"/>

  <!-- ===== Internal methods ===== -->
  <internal modifiers="protected" type="double" name="computePowerLevel">
    <parameter type="int" name="mode"/>
    <thrown>java.lang.Exception</thrown>
    <body equipmentRef="oven">
      if (mode &lt;= 0 || mode &gt; MAX_MODE) {
        throw new fr.sorbonne_u.exceptions.PreconditionException("mode &gt; 0 &amp;&amp; mode &lt;= MAX_MODE");
      }
      double power;
	  if (mode == 1) { // DEFROST
        power = DEFROST_POWER_LEVEL;

      } else {
        power = oven.getMaxPowerLevelJava4();
      }

      return power;
    </body>
  </internal>

  <internal modifiers="protected" type="void" name="setNewPowerLevel">
    <parameter type="double" name="newPowerLevel"/>
    <thrown>java.lang.Exception</thrown>
    <body equipmentRef="oven">
      if (newPowerLevel &lt; 0.0) {
        throw new fr.sorbonne_u.exceptions.PreconditionException("newPowerLevel &gt;= 0.0");
      }
      double maxPowerLevel = oven.getMaxPowerLevelJava4();
      if (newPowerLevel &gt; maxPowerLevel) {
        newPowerLevel = maxPowerLevel;
      }
      oven.setCurrentPowerLevelJava4(newPowerLevel);
    </body>
  </internal>

  <internal modifiers="protected" type="void" name="computeAndSetNewPowerLevel">
    <parameter type="int" name="newMode"/>
    <thrown>java.lang.Exception</thrown>
    <body>
      double newPowerLevel = computePowerLevel(newMode);
      setNewPowerLevel(newPowerLevel);
    </body>
  </internal>

  <!-- ===== Interface methods ===== -->
  <maxMode>
    <body>
      return MAX_MODE;
    </body>
  </maxMode>

  <upMode>
    <body>
      try {
        computeAndSetNewPowerLevel(currentMode + 1);
        currentMode++;
      } catch (Exception e) {
        return false;
      }
      return true;
    </body>
  </upMode>

  <downMode>
    <body>
      try {
        computeAndSetNewPowerLevel(currentMode - 1);
        currentMode--;
      } catch (Exception e) {
        return false;
      }
      return true;
    </body>
  </downMode>

  <setMode>
    <parameter name="modeIndex"/>
    <body>
      try {
        computeAndSetNewPowerLevel(modeIndex);
        currentMode = modeIndex;
      } catch (Exception e) {
        return false;
      }
      return true;
    </body>
  </setMode>

  <currentMode>
    <body>
      if (suspended()) {
        return 0;
      } else {
        return currentMode;
      }
    </body>
  </currentMode>

  <getModeConsumption>
    <parameter name="modeIndex"/>
    <body>
      return computePowerLevel(modeIndex);
    </body>
  </getModeConsumption>

  <suspended>
    <body>
      return isSuspended;
    </body>
  </suspended>

  <suspend>
    <body equipmentRef="oven">
      try {
        oven.setCurrentPowerLevelJava4(0.0);
        isSuspended = true;
      } catch (Exception e) {
        return false;
      }
      return true;
    </body>
  </suspend>

  <resume>
    <body equipmentRef="oven">
      try {
        computeAndSetNewPowerLevel(currentMode);
        isSuspended = false;
      } catch (Exception e) {
        return false;
      }
      return true;
    </body>
  </resume>

  <emergency>
    <body equipmentRef="oven">
      double currentTemperature = oven.getCurrentTemperatureJava4();
      double targetTemperature = oven.getTargetTemperatureJava4();
      double delta = Math.abs(targetTemperature - currentTemperature);
      double ret;
      if (currentTemperature &lt; MIN_ADMISSIBLE_TEMP || delta &gt;= MAX_ADMISSIBLE_DELTA) {
        ret = 1.0;
      } else {
        ret = delta / MAX_ADMISSIBLE_DELTA;
      }
      return ret;
    </body>
  </emergency>

</control-adapter>
